<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Python Code Runner</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 16px; background: #f5f5f5; }
    h1 { margin-bottom: 16px; }
    section { background: #fff; padding: 16px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 12px; font-weight: 600; }
    textarea, input[type="text"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    textarea { min-height: 400px; font-family: monospace; font-size: 13px; }
    button { margin-top: 12px; padding: 10px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    button:hover { background: #0055aa; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #result { margin-top: 16px; }
    #logs { white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4; padding: 12px; border-radius: 4px; min-height: 100px; font-family: monospace; font-size: 13px; overflow-x: auto; }
    .status { padding: 8px 12px; border-radius: 4px; margin-bottom: 12px; }
    .status.succeeded { background: #d4edda; color: #155724; }
    .status.failed { background: #f8d7da; color: #721c24; }
    .artifacts a { display: inline-block; margin-right: 12px; color: #0066cc; }
  </style>
</head>
<body>
  <h1>Python Code Runner</h1>

  <section>
    <form id="runForm">
      <label for="code">Python Code</label>
      <textarea id="code">import os
import pandas as pd
import matplotlib.pyplot as plt

# Configure Chinese font (Noto Sans CJK SC is pre-configured in Docker)
import matplotlib
matplotlib.rcParams['font.sans-serif'] = ['Noto Sans CJK SC', 'DejaVu Sans']
matplotlib.rcParams['axes.unicode_minus'] = False

# Create sample data
data = {
    "城市": ["北京", "上海", "广州", "深圳", "杭州"],
    "人口(万)": [2154, 2487, 1530, 1756, 1237],
    "GDP(亿)": [41610, 47218, 28839, 32387, 19476],
    "增长率(%)": [5.2, 4.8, 5.1, 6.3, 7.5]
}
df = pd.DataFrame(data)
print("DataFrame:")
print(df)

output_dir = os.environ["JOB_OUTPUT_DIR"]

# Save to Excel
excel_path = os.path.join(output_dir, "data.xlsx")
df.to_excel(excel_path, index=False)
print(f"\nSaved Excel: data.xlsx")

# Create chart with Chinese labels
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))

# Bar chart - GDP
ax1.bar(df["城市"], df["GDP(亿)"], color=['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'])
ax1.set_title("主要城市GDP对比", fontsize=14)
ax1.set_xlabel("城市", fontsize=12)
ax1.set_ylabel("GDP (亿元)", fontsize=12)
ax1.tick_params(axis='x', rotation=0)

# Line chart - Growth rate
ax2.plot(df["城市"], df["增长率(%)"], marker='o', linewidth=2, markersize=8, color='#E74C3C')
ax2.set_title("城市GDP增长率", fontsize=14)
ax2.set_xlabel("城市", fontsize=12)
ax2.set_ylabel("增长率 (%)", fontsize=12)
ax2.grid(True, alpha=0.3)

plt.tight_layout()
chart_path = os.path.join(output_dir, "chart.png")
plt.savefig(chart_path, dpi=150, bbox_inches='tight')
print(f"Saved chart: chart.png")
print("\nDone!")
</textarea>

      <label for="inputFiles">Input Files (optional)</label>
      <input id="inputFiles" type="file" multiple />

      <button type="submit" id="submitBtn">Run Code</button>
    </form>
  </section>

  <section id="result" style="display: none;">
    <div id="statusBox" class="status"></div>
    <div class="artifacts" id="artifacts"></div>
    <label>Output Logs</label>
    <div id="logs"></div>
  </section>

  <script>
    const form = document.getElementById("runForm");
    const codeArea = document.getElementById("code");
    const inputFiles = document.getElementById("inputFiles");
    const submitBtn = document.getElementById("submitBtn");
    const resultSection = document.getElementById("result");
    const statusBox = document.getElementById("statusBox");
    const artifactsDiv = document.getElementById("artifacts");
    const logsDiv = document.getElementById("logs");

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = "Running...";
      resultSection.style.display = "none";

      const code = codeArea.value;
      const codeBlob = new Blob([code], { type: "text/plain" });
      const codeFile = new File([codeBlob], "main.py");

      const fd = new FormData();
      fd.append("spec", JSON.stringify({ entry: "main.py", timeout_sec: 60 }));
      fd.append("code_files", codeFile, "main.py");

      for (const f of inputFiles.files) {
        fd.append("input_files", f, f.name);
      }

      try {
        const resp = await fetch("/run", { method: "POST", body: fd });
        const data = await resp.json();

        resultSection.style.display = "block";
        statusBox.className = "status " + data.status;
        statusBox.textContent = `Status: ${data.status} | Exit code: ${data.exit_code ?? "N/A"}` + (data.error ? ` | Error: ${data.error}` : "");

        logsDiv.textContent = data.logs || "(no output)";

        artifactsDiv.innerHTML = "";
        if (data.artifacts && data.artifacts.length > 0) {
          const label = document.createElement("strong");
          label.textContent = "Artifacts: ";
          artifactsDiv.appendChild(label);
          data.artifacts.forEach(name => {
            const a = document.createElement("a");
            a.href = `/jobs/${data.job_id}/artifacts/${encodeURIComponent(name)}`;
            a.textContent = name;
            a.target = "_blank";
            artifactsDiv.appendChild(a);
          });
        }
      } catch (err) {
        resultSection.style.display = "block";
        statusBox.className = "status failed";
        statusBox.textContent = `Error: ${err.message}`;
        logsDiv.textContent = "";
        artifactsDiv.innerHTML = "";
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Run Code";
      }
    });
  </script>
</body>
</html>
